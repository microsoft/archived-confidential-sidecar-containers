/* Copyright (c) Microsoft Corporation.
   Licensed under the MIT License. */

#include <sys/ioctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <stdbool.h>
#include <stdlib.h>

#include "helpers.h"
#include "snp-psp.h"

bool fetchAttestationReport(char report_data_hexstring[], char host_data_hexstring[], void **snp_report)
{
 
    snp_attestation_report attestation_report;

    uint8_t *default_report = decodeHexString("01000000010000001f00030000000000010000000000000000000000000000000200000000000000000000000000000000000000010000000000000000000028010000000000000000000000000000007ab000a323b3c873f5b81bbe584e7c1a26bcf40dc27e00f8e0d144b1ed2d14f10000000000000000000000000000000000000000000000000000000000000000e29af700e85b39996fa38226d2804b78cad746ffef4477360a61b47874bdecd640f9d32f5ff64a55baad3c545484d9ed28603a3ea835a83bd688b0ec1dcb36b6b8c22412e5b63115b75db8628b989bc598c475ca5f7683e8d351e7e789a1baff19041750567161ad52bf0d152bd76d7c6f313d0a0fd72d0089692c18f521155800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040aea62690b08eb6d680392c9a9b3db56a9b3cc44083b9da31fb88bcfc493407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000028000000000000000000000000000000000000000000000000e6c86796cd44b0bc6b7c0d4fdab33e2807e14b5fc4538b3750921169d97bcf4447c7d3ab2a7c25f74c1641e2885c1011d025cc536f5c9a2504713136c7877f480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003131c0f3e7be5c6e400f22404596e1874381e99d03de45ef8b97eee0a0fa93a4911550330343f14dddbbd6c0db83744f000000000000000000000000000000000000000000000000db07c83c5e6162c2387f3b76cd547672657f6a5df99df98efee7c15349320d83e086c5003ec43050a9b18d1c39dedc340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000", 0);
    
    memcpy((uint8_t*)&attestation_report, default_report, sizeof(snp_attestation_report));
    memset(attestation_report.report_data, 0 , 64);
    memset(attestation_report.host_data, 0 , 32);
    
    // MAA expects a SHA-256. So we use 32 bytes as size instead of msg_report_in.report_data
    // the report data is passed as a hexstring which needs to be decoded into an array of 
    // unsigned bytes

    uint8_t *reportData = decodeHexString(report_data_hexstring, 64);     
    memcpy(attestation_report.report_data, reportData , strlen(report_data_hexstring)/2);

    uint8_t *hostData = decodeHexString(host_data_hexstring, 32);   
    memcpy(attestation_report.host_data, hostData , strlen(host_data_hexstring)/2);

    *snp_report = (snp_attestation_report *) malloc (sizeof(snp_attestation_report));        
    memcpy(*snp_report, &attestation_report, sizeof(snp_attestation_report));

    return true;
}

// Main expects the hex string representation of the report data as the only argument
// Prints the raw binary format of the report so it can be consumed by the tools under
// the directory internal/guest/attestation
int main(int argc, char *argv[])
{    
    bool success;
    uint8_t *snp_report_hex;

    if (argc > 1) {        
        success = fetchAttestationReport(argv[1], argv[2], (void*) &snp_report_hex);    
    } else {        
        success = fetchAttestationReport("", "", (void*) &snp_report_hex);    
    }
   
    if (success == true) {
        for (size_t i = 0; i < sizeof(snp_attestation_report); i++) {
            fprintf(stdout, "%02x", (uint8_t) snp_report_hex[i]);            
        }

        return 0;
    }

    return -1;
}
